{% extends "base.html" %}

{% block title %}
Wage Report {{report_name}}
{% endblock %}

{% block head %}
{{super()}}
<style>
.detail-report > * {
    display: none;
}

table.payment-summary {
    width: 100%;
}
</style>
{% endblock %}

{% block content %}
<a class="pure-button" href="{{url_for('list_reports')}}">Back to list</a>
<table class="payment-summary pure-table">
    <thead>
        <tr>
            <td>Person ID</td>
            <td>Name</td>
            <td>Month Payment</td>
            <td>Base Payment</td>
            <td>Evening Payment</td>
            <td>Overtime Payment</td>
        </tr>
    </thead>

    <tbody>
        {% for person_id, report in wage %}
        <tr data-person-id="{{person_id}}" onclick="viewDetail('{{person_id}}')">
            <td>{{person_id}}</td>
            <td>{{report.name}}</td>
            <td>{{report.month_total}}</td>
            <td>{{report.base_total}}</td>
            <td>{{report.evening_total}}</td>
            <td>{{report.overtime_total}}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="detail-report">
    {% for person_id, _ in wage %}
    <div data-person-id="{{person_id}}">
        <h3>{{wage_json[person_id]["name"]}}</h3>

        <div class="pure-g">
            <div class="pure-u-2-3">
                <table>
                    {% for day in range(0, 7) %}
                    <tr>
                        <td>{{["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"][day]}}</td>
                        {% for hour in range(0, 24) %}
                        <td style="transform: scale({{punchcards[person_id][day][hour]}}); opacity: {{punchcards[person_id][day][hour]}}; width: 20px; height: 20px;">
                            <svg height="20" width="20">
                            <circle cx="10" cy="10" r="10"  stroke-width="3" fill="black" />
                            </svg> 
                        </td> 
                        {% endfor %}
                    </tr>
                    {% endfor %}
                
                    <tr>
                        <td></td>
                        {% for hour in range(0, 24) %}
                        <td>{{hour}}</td>
                        {% endfor %}
                    </tr>
                </table>
            </div>
            <div class="pure-u-1-3">
                <div class="payment-breakdown-chart">
                    <canvas width="400" height="400"></canvas>
                </div>
            </div>
        </div>

    </div>
    {% endfor %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js"></script>
<script src="https://unpkg.com/vue"></script>

<script>
    var wage = {{wage_json | tojson | safe}};

    var activeId = Object.keys(wage)[0];
    var $activeReport;
    var $activeSummaryRow;
    var $detailReport = document.querySelector(".detail-report");
    var $paymentSummary = document.querySelector("table.payment-summary");
    var paymentBreakdownChart;

    viewDetail(activeId);

    function viewDetail(personId) {
        activeId = personId;

        if ($activeReport)
            $activeReport.style.display = "none";

        $activeReport = $detailReport.querySelector("[data-person-id='" + activeId + "']");
        $activeReport.style.display = "block";

        if ($activeSummaryRow)
            $activeSummaryRow.className = "";

        $activeSummaryRow = $paymentSummary.querySelector("tr[data-person-id='" + activeId + "']");
        $activeSummaryRow.className = "pure-table-odd";

        if (paymentBreakdownChart)
            paymentBreakdownChart.destroy();

        var ctx = $activeReport.querySelector(".payment-breakdown-chart canvas").getContext("2d");
        paymentBreakdownChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [
                        wage[personId].base_total,
                        wage[personId].evening_total,
                        wage[personId].overtime_total,
                        ]
                }],

                labels: ["Base", "Evening", "Overtime"]
            },
            options: {
                animation: {animateRotate: false}
            }
        });
    }
</script>
{% endblock %}
